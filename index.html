<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tetris&nbsp;+&nbsp;Ghost</title>
  <style>
    body{background:#121725;margin:0;display:flex;flex-direction:column;align-items:center;font-family:monospace;color:#fff;user-select:none;-webkit-user-select:none;}
    /* 상단 정보 바 */
    #topBar{display:flex;justify-content:space-between;width:320px;margin-top:10px;}
    #score,#level{font-size:16px;}
    /* 메인 컨테이너 */
    #container{display:flex;gap:20px;margin-top:10px;}
    /* 보드 */
    #game{display:grid;grid-template-columns:repeat(10,30px);grid-template-rows:repeat(20,30px);gap:2px;background:#1e2233;padding:5px;border:4px solid #333;touch-action:none;}
    /* 다음 블록 */
    #next{display:grid;grid-template-columns:repeat(4,30px);grid-template-rows:repeat(4,30px);gap:2px;background:#1e2233;padding:5px;border:2px solid #666;}
    /* 공통 셀 */
    .cell{width:30px;height:30px;background:#121725;border-radius:3px;}
    /* 블록 색상 */
    .I{background:#2cdfd4}.J{background:#2c6cdf}.L{background:#df852c}.O{background:#dfce2c}.S{background:#2cdf6d}.Z{background:#df2c2c}.T{background:#a32cdf}
    /* 유령(고스트) 셀 */
    .ghost{background:none;border:1px dashed #888;border-radius:3px;opacity:.6;}
    /* PC 컨트롤 버튼 */
    #controls{display:flex;gap:10px;margin-top:10px;}
    /* 모바일 전용 버튼 */
    #mobileControls{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:none;gap:12px;}
    #mobileControls button,#controls button{padding:10px 20px;font-size:18px;background:#4f9eff;border:none;border-radius:8px;color:#fff;font-weight:bold;}
    /* 모바일 표시 */
    @media(max-width:600px){#mobileControls{display:flex;}#controls{display:none;}#container{flex-direction:column;}}
  </style>
</head>
<body>
  <h2>테트리스+ (고스트/모바일)</h2>
  <div id="topBar">
    <div id="score">점수: 0</div>
    <div id="level">레벨: 1</div>
  </div>

  <!-- 데스크톱 컨트롤 -->
  <div id="controls">
    <button onclick="startGame()">게임 시작</button>
    <button onclick="move(-1)">◀</button>
    <button onclick="rotateCurrent()">⟳</button>
    <button onclick="move(1)">▶</button>
    <button onclick="moveDown()">▼</button>
  </div>

  <!-- 모바일 컨트롤 -->
  <div id="mobileControls">
    <button id="mLeft">◀</button>
    <button id="mRotate">⟳</button>
    <button id="mRight">▶</button>
    <button id="mDown">▼</button>
  </div>

  <div id="container">
    <div id="game"></div>
    <div>
      <div style="text-align:center;margin-bottom:4px;">다음 블록</div>
      <div id="next"></div>
    </div>
  </div>

<script>
  /* =================== 상수 =================== */
  const COLS=10,ROWS=20;
  const COLORS={I:'I',J:'J',L:'L',O:'O',S:'S',Z:'Z',T:'T'};
  const BLOCKS={
    I:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]]],
    J:[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]],
    L:[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]],
    O:[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],
    S:[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]]],
    Z:[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],
    T:[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]]]
  };
  /* =================== 상태 =================== */
  let board,current,nextBlock,interval,score=0,level=1;

  /* ============ 보드 관련 ============ */
  function resetBoard(){board=Array.from({length:ROWS},()=>Array(COLS).fill(0));}
  function randomBlock(){const keys=Object.keys(BLOCKS);const type=keys[Math.floor(Math.random()*keys.length)];return{type,shape:BLOCKS[type][0].map(r=>r.slice()),row:-1,col:3};}

  /* ============ 충돌 및 회전 ============ */
  function rotate(mat){const N=mat.length,res=Array.from({length:N},()=>Array(N).fill(0));for(let i=0;i<N;i++)for(let j=0;j<N;j++)res[j][N-1-i]=mat[i][j];return res;}
  function collides(shape,row,col){for(let i=0;i<shape.length;i++)for(let j=0;j<shape[i].length;j++)if(shape[i][j]){const x=col+j,y=row+i;if(x<0||x>=COLS||y>=ROWS||(y>=0&&board[y][x]))return true;}return false;}
  function wallKick(rot,row,col){for(const o of[0,-1,1,-2,2])if(!collides(rot,row,col+o))return col+o;return null;}
  function rotateCurrent(){const rot=rotate(current.shape);const ncol=wallKick(rot,current.row,current.col);if(ncol!==null){current.shape=rot;current.col=ncol;draw();}}

  /* ============ 줄 제거 & 점수 ============ */
  function fix(){current.shape.forEach((r,i)=>r.forEach((v,j)=>{if(v&&current.row+i>=0)board[current.row+i][current.col+j]=current.type;}));}
  function clearLines(){let cleared=0;for(let y=ROWS-1;y>=0;y--){if(board[y].every(v=>v)){board.splice(y,1);board.unshift(Array(COLS).fill(0));cleared++;y++;}}
    if(cleared){const pts=[0,100,300,500,800];score+=pts[cleared];if(score>=level*1000){level++;updateSpeed();}updateHUD();}}
  function updateHUD(){document.getElementById("score").textContent=`점수: ${score}`;document.getElementById("level").textContent=`레벨: ${level}`;}
  function updateSpeed(){clearInterval(interval);interval=setInterval(moveDown,500-Math.min(level-1,9)*40);/*최대속도 140ms*/}

  /* ============ 움직임 ============ */
  function moveDown(){if(!collides(current.shape,current.row+1,current.col)){current.row++;}else{fix();clearLines();current=nextBlock;nextBlock=randomBlock();if(collides(current.shape,current.row,current.col)){clearInterval(interval);alert("게임 오버!");return;}}draw();}
  function move(dx){if(!collides(current.shape,current.row,current.col+dx)){current.col+=dx;draw();}}

  /* ============ 고스트 블록 ============ */
  function ghostRow(){let r=current.row;while(!collides(current.shape,r+1,current.col))r++;return r;}

  /* ============ 그리기 ============ */
  function draw(){const g=document.getElementById("game");g.innerHTML="";
    // 기본 보드
    for(let y=0;y<ROWS;y++)for(let x=0;x<COLS;x++){const cell=document.createElement("div");cell.className="cell";if(board[y][x])cell.classList.add(COLORS[board[y][x]]);g.appendChild(cell);}  
    // 고스트
    const gr=ghostRow();current.shape.forEach((r,i)=>r.forEach((v,j)=>{if(v){const y=gr+i,x=current.col+j;if(y>=0){g.children[y*COLS+x].classList.add("ghost");}}}));
    // 현재 블록
    current.shape.forEach((r,i)=>r.forEach((v,j)=>{if(v){const y=current.row+i,x=current.col+j;if(y>=0){g.children[y*COLS+x].classList.add(COLORS[current.type]);}}}));
    // 다음 블록
    const n=document.getElementById("next");n.innerHTML="";for(let y=0;y<4;y++)for(let x=0;x<4;x++){const cell=document.createElement("div");cell.className="cell";if(nextBlock.shape[y]&&nextBlock.shape[y][x])cell.classList.add(COLORS[nextBlock.type]);n.appendChild(cell);} }

  /* ============ 게임 시작 ============ */
  function startGame(){score=0;level=1;updateHUD();resetBoard();current=randomBlock();nextBlock=randomBlock();draw();if(interval)clearInterval(interval);updateSpeed();}

  /* ============ 이벤트 ============ */
  document.addEventListener("keydown",e=>{if(e.code==="ArrowLeft")move(-1);else if(e.code==="ArrowRight")move(1);else if(e.code==="ArrowUp")rotateCurrent();else if(e.code==="ArrowDown")moveDown();});
  // 모바일 버튼
  const bind=(id,fn)=>{const b=document.getElementById(id);b.addEventListener("touchstart",e=>{e.preventDefault();fn();});b.addEventListener("mousedown",fn);};
  bind("mLeft",()=>move(-1));bind("mRight",()=>move(1));bind("mRotate",rotateCurrent);bind("mDown",moveDown);
</script>
</body>
</html>
